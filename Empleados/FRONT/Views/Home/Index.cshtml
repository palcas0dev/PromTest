@{
    ViewBag.Title = "Empleados";
}


<div id="divControles" style="padding:2rem;">
    <button class="btn btn-success" onclick="nuevo()">Nuevo</button>
    <button class="btn btn-primary" onclick="verArbol()">Ver Arbol</button>
</div>
<hr />

<div id="divTable">
    <table id="tblEmpleados"></table>
</div>



<div id="modal" class="modal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 id="modalTitle" class="modal-title">Modal title</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div id="modalBody" class="modal-body">
                <p>Modal body text goes here.</p>
            </div>
            <div id="modalFooter" class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                <button type="button" class="btn btn-primary">Save changes</button>
            </div>
        </div>
    </div>
</div>


<script>
    var empleados = [];
    const myModal = new bootstrap.Modal('#modal', {})

    $(document).ready(function () {
        obtenerEmpleados();
    });

    function obtenerEmpleados() {
        $.ajax({
            url: `/Home/obtenerEmpleados`,
            method: 'GET',
            contentType: 'application/json',
        }).done(function (json) {
            console.log(`obtener empleados`, json);
            if (json.success) {
                empleados = [];
                json.data.forEach(emp => {
                    empleados.push(emp);
                });
                $('#tblEmpleados').DataTable().destroy();
                $('#tblEmpleados').empty(); // Borra también el contenido HTML

                $('#tblEmpleados').DataTable({
                    data: json.data,
                    columns: [
                        { data: 'codigo', title: 'Codigo' },
                        { data: 'puesto', title: 'Puesto' },
                        { data: 'nombre', title: 'Nombre' },
                        { data: 'codigo_jefe', title: 'Codigo Jefe' },
                        {
                            data: null,
                            title: 'Acciones',
                            orderable: false,
                            render: function (data, type, row) {
                                return `
                                    <button class="btn btn-warning" data-id="${row.codigo}" onclick="editar(${row.codigo})">Editar</button>
                                    <button class="btn btn-danger" data-id="${row.codigo}"  onclick="eliminar(${row.codigo})">Eliminar</button>
                                `
                            }
                        }

                    ]
                });
            }
        }).fail(function (jqXHR, textStatus, errorThrown) {
            console.error('Error:', textStatus, errorThrown);
        });
    }

    function verArbol() {
        myModal.show()

        $('#modalTitle').empty();
        $('#modalTitle').html(`Arbol de Empleados`);

        $('#modalBody').empty();
        $('#modalBody').html(`
            <div id="divArbol"></div>
        `);

        $('#modalFooter').empty();
        $('#modalFooter').html(`
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        `);
        $.ajax({
            url: `/Home/obtenerArbol`,
            method: 'GET',
            contentType: 'application/json',
            cache: false,
            processData: false,
        }).done(function (json) {
            console.log(`obtener arbol`, json);
            if (json.success) {
                $('#divArbol').jstree({
                    "core": {
                        "animation": 0,
                        "check_callback": true,
                        "themes": { "stripes": true },
                        'data': json.data
                        
                    },
                    "types": {
                        "#": {
                            "max_children": 1,
                            "max_depth": 4,
                            "valid_children": ["root"]
                        },
                        "root": {
                            "icon": "/static/3.3.17/assets/images/tree_icon.png",
                            "valid_children": ["default"]
                        },
                        "default": {
                            "valid_children": ["default", "file"]
                        },
                        "file": {
                            "icon": "glyphicon glyphicon-file",
                            "valid_children": []
                        }
                    },
                    "plugins": [
                        "contextmenu", "dnd", "search",
                        "state", "types", "wholerow"
                    ]
                });

            } else {
                alert(json.mensaje);
            }
        }).fail(function (jqXHR, textStatus, errorThrown) {
            console.error('Error:', textStatus, errorThrown);
            alert('No se pudo obtener el arbol.');
        });
    }

    function nuevo() {
        /*const myModal = new bootstrap.Modal('#modal', {})*/
        myModal.show()

        $('#modalTitle').empty();
        $('#modalTitle').html(`Nuevo Empleado`);

        $('#modalBody').empty();
        $('#modalBody').html(`
        <div><label>Puesto</label></div>
        <div>
            <input type="text" placeholder="Puesto" id="txtMPuesto" />
        </div>
        <div><label>Nombre</label></div>
        <div>
            <input type="text" placeholder="Nombre" id="txtMNombre" />
        </div>
        <div><label>Codigo Jefe</label></div>
        <div>
            <select id="sltJefe"></select >
        </div>
    `);

        $('#modalFooter').empty();
        $('#modalFooter').html(`
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
        <button type="button" class="btn btn-success"  onclick="guardarEmpleado()">Guardar</button>
    `);

        $('#sltJefe').empty();
        $('#sltJefe').append(`<option value=0> [Ninguno] </option>`);
        empleados.forEach((emp) => {
            $('#sltJefe').append(`<option value="${emp.codigo}"> ${emp.puesto} :: ${emp.nombre} </option>`);
        })
    }

    function guardarEmpleado() {
        let puesto = $('#txtMPuesto').val();
        let nombre = $('#txtMNombre').val();
        let codigo_jefe = $('#sltJefe').val();

        $.ajax({
            url: `/Home/nuevoEmpleado`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                codigo: 0,
                puesto,
                nombre,
                codigo_jefe
            }),
            cache: false,
            processData: false,
            dataType: 'json',
        }).done(function (json) {
            console.log(`nuevo empleado `, json);
            //const myModal = new bootstrap.Modal('#modal', {})
            myModal.hide();
            obtenerEmpleados();
            alert(json.mensaje);

        }).fail(function (jqXHR, textStatus, errorThrown) {
            console.error('Error:', textStatus, errorThrown);
            alert('No se pudo guardar la informacion.');
        });
    }

    function editar(codigoEmpleado) {
        //const myModal = new bootstrap.Modal('#modal', {})
        myModal.show()

        $('#modalTitle').empty();
        $('#modalTitle').html(`Editar Empleado: ${codigoEmpleado}`);

        $('#modalBody').empty();
        $('#modalBody').html(`
            <div><label>Puesto</label></div>
            <div>
                <input type="text" placeholder="Puesto" id="txtMPuesto" />
            </div>
            <div><label>Nombre</label></div>
            <div>
                <input type="text" placeholder="Nombre" id="txtMNombre" />
            </div>
            <div><label>Codigo Jefe</label></div>
            <div>
                <select id="sltJefe"></select >
            </div>
        `);

        $('#modalFooter').empty();
        $('#modalFooter').html(`
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-warning"  onclick="actualizarEmpleado(${codigoEmpleado })">Actualizar Datos</button>
        `);

        $('#sltJefe').empty();
        $('#sltJefe').append(`<option value=0> [Ninguno] </option>`);
        empleados.forEach((emp) => {
            $('#sltJefe').append(`<option value="${emp.codigo}"> ${emp.puesto} :: ${emp.nombre} </option>`);
        })

        $.ajax({
            url: `/Home/obtenerEmpleado`,
            method: 'GET',
            contentType: 'application/json',
            data: { Id: codigoEmpleado }
        }).done(function (json) {
            console.log(`obtener empleado ${codigoEmpleado}`, json);
            if (json.success) {
                $('#txtMPuesto').val(json.data[0].puesto);
                $('#txtMNombre').val(json.data[0].nombre);
                $('#sltJefe').val(json.data[0].codigo_jefe);
            } else {
                alert(json.mensaje);
            }

        }).fail(function (jqXHR, textStatus, errorThrown) {
            console.error('Error:', textStatus, errorThrown);
            alert('No se pudo obtener la informacion.');
        });
    }

    function actualizarEmpleado(codigoEmpleado) {
        let puesto = $('#txtMPuesto').val();
        let nombre = $('#txtMNombre').val();
        let codigo_jefe = $('#sltJefe').val();

        $.ajax({
            url: `/Home/actualizarEmpleado`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify({
                codigo: codigoEmpleado,
                puesto,
                nombre,
                codigo_jefe
            }),
            cache: false,
            processData: false,
            dataType: 'json',
        }).done(function (json) {
            console.log(`actualizar empleado ${codigoEmpleado}`, json);
            //const myModal = new bootstrap.Modal('#modal', {})
            myModal.hide();
            obtenerEmpleados();
            alert(json.mensaje);

        }).fail(function (jqXHR, textStatus, errorThrown) {
            console.error('Error:', textStatus, errorThrown);
            alert('No se pudo actualizar la informacion.');
        });

    }

    function eliminar(codigoEmpleado) {
        //const myModal = new bootstrap.Modal('#modal', {})
        myModal.show()

        $('#modalTitle').empty();
        $('#modalTitle').html(`Borrar Empleado: ${codigoEmpleado}`);

        $('#modalBody').empty();
        $('#modalBody').html(`
            <div><label>¿Desea Eliminar los datos del Empleado seleccionado?</label></div>
        `);

        $('#modalFooter').empty();
        $('#modalFooter').html(`
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
            <button type="button" class="btn btn-danger"  onclick="borrarEmpleado(${codigoEmpleado })">Borrar</button>
        `);
    }

    function borrarEmpleado(codigoEmpleado) {
        $.ajax({
            url: `/Home/borrarEmpleado`,
            method: 'POST',
            contentType: 'application/json',
            data: JSON.stringify( { Id: codigoEmpleado }),
            cache: false,
            processData: false,
            dataType: 'json',
        }).done(function (json) {
            console.log(`borrar empleado ${codigoEmpleado}`, json);
            //const myModal = new bootstrap.Modal('#modal', {})
            myModal.hide();
            obtenerEmpleados();
            alert(json.mensaje);

        }).fail(function (jqXHR, textStatus, errorThrown) {
            console.error('Error:', textStatus, errorThrown);
            alert('No se pudo borra la informacion.');
        });

    }


</script>